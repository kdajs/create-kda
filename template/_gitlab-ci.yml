image: harbor.duowan.com/ued/kda

variables:
  GIT_SUBMODULE_STRATEGY: recursive

stages:
  - build
  - release

# 构建
build:
  stage: build
  tags:
    - yyci_office
  only:
    - master
    - test
  artifacts:
    expire_in: 1 week
    paths:
    - dist
    - package.json
  script:
    - pnpm install
    - pnpm build:release

.release:
  stage: release
  tags:
    - yyci_office
  script:
    - pnpm add @yy/rv-cli --registry=https://npm-registry.duowan.com --global
    - rv .

# 发布 - 测试环境
release_test:
  extends: .release
  only:
    - test

# 发布 - 生产环境
release_production:
  extends: .release
  when: manual
  only:
    - master
